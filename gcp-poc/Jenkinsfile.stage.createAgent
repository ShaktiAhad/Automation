#!/usr/bin/env groovy
import groovy.json.JsonSlurperClassic

def call(){
    def load_release_info = load "${env.WORKSPACE}/Automation/gcp-poc/Jenkinsfile.util.readJsonfile"
    def restore_agent = load "${env.WORKSPACE}/Automation/gcp-poc/Jenkinsfile.util.restoreAgent"
    def apiPreparation = load "${env.WORKSPACE}/Automation/gcp-poc/Jenkinsfile.util.apiPreparation"
    def existing_agents_list = load "${env.WORKSPACE}/Automation/gcp-poc/Jenkinsfile.util.getExistingAgent"
    def exisitng_agents = existing_agents_list()
    if (load_release_info()[0].size() != 0){
        println ("** Start CREATING agent **")
        for (i in [load_release_info()[0],load_release_info()[1]].transpose()){
            if(!(i[0] in exisitng_agents)){
                def create_agent = apiPreparation(null)[0]
                def payload = """{
                    "displayName": "${i[0]}",
                    "defaultLanguageCode": "en",
                    "timeZone": "Asia/Tokyo", 
                    "description": "${i[0]} agent"
                    }"""
                create_agent.setRequestMethod("POST")
                create_agent.setDoOutput(true)
                create_agent.getOutputStream().write(payload.getBytes("UTF-8"))
                def agnt_details = new JsonSlurperClassic().parseText(create_agent.inputStream.text)
                def name = agnt_details.name.split('/')
                agent_id = name[name.length - 1]
                display_name = agnt_details.displayName
                blob_file_name = i[1]
                def agntName_n_id = ["${display_name}": " ${agent_id}"]
                println ("--> ${agntName_n_id} Agent is created")
                agnt_details.close()
                restore_agent(agent_id, display_name, blob_file_name, "create")
                println ("--> Blob is uploaded to agent:${display_name}")

            }
            else{
                println("--> ${i[0]} is already exists. Can't be recreated.")
            }
        }
    }
}
return this