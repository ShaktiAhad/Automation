#!/usr/bin/env groovy
import groovy.json.JsonSlurper

def call(){
    def load_release_info = load "${env.WORKSPACE}/Automation/gcp-poc/Jenkinsfile.util.readJsonfile"
    def existing_agents_list = load "${env.WORKSPACE}/Automation/gcp-poc/Jenkinsfile.stage.getExistingAgent"
    def restore_agent = load "${env.WORKSPACE}/Automation/gcp-poc/Jenkinsfile.util.restoreAgent"
    def existing_agent_name = existing_agents_list()*.key
    if (load_release_info()[2].size() != 0){
        println ("** Start UPDATING existing agent **")
        def apiPreparation = load "${env.WORKSPACE}/Automation/gcp-poc/Jenkinsfile.util.apiPreparation"
        def create_agent = apiPreparation(null)[0]
        for (i in [load_release_info()[2],load_release_info()[3]]){
            if(each_agent in existing_agent_name){
                println ("--> Found the agent: [${each_agent}: ${existing_agents_list()[each_agent]}]")
                restore_agent(agent_id, i[0], i[1])
                println ("--> Blob is uploaded to ${each_agent} agent")
            }
            else{
                println("--> ${each_agent} doesn't exist.")
            }
        }
    }
}