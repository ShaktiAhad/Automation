#!/usr/bin/env groovy
import groovy.json.JsonSlurperClassic

def call(agent_id, agent_name, blob_file, task_type){
    def apiPreparation = load "${env.WORKSPACE}/Automation/gcp-poc/Jenkinsfile.util.apiPreparation"
    env.token = new File("${env.WORKSPACE}/token.txt").text.trim()
    def restore_agent = new URL(apiPreparation(agent_id)[1]).openConnection()
    restore_agent.setRequestProperty("Authorization", "Bearer ${token}")
    restore_agent.setRequestProperty("Content-Type", "application/json")
    // def restore_agent = apiPreparation(agent_id)[1]
    def payload = """{
        "agentUri": "gs://${PREPROD_BUCKET}/dialogflowcx/preprod/${params.version}/${task_type}/${agent_name}/${blob_file}"
        }"""
    println payload
    restore_agent.setRequestMethod("POST")
    restore_agent.setDoOutput(true)
    restore_agent.getOutputStream().write(payload.getBytes("UTF-8"))
    new JsonSlurperClassic().parseText(restore_agent.inputStream.text)
}
return this